<html>
<head>
  <link href='style.css' rel='stylesheet'>
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
  <style  type="text/css">
    /**
     * markers
     */
    .djs-visual {
      marker-end: url(#sequenceflow-end-marker);
    }
    #page-main-menu {
        width: 800px;
    }
    #main-svg-canvas {
        width: 100%;
        height: 500px;
    }
  </style>
  <script>

    function createDiagram(id, menuid) {
      var xinc = 50;
      var container = document.querySelector('#' + id);
      var menuContainer = document.querySelector('#' + menuid);
      var Diagram = require('diagram');
      var diagram = new Diagram({
        canvas: {
          container: container,
          width: 700,
          height: 500
        },
        plugins: [
          'selectionUI',
          'dragUI',
          'standardPalette' ],
        menu: [
          {
            id:   'main-menu',
            parentContainer: menuContainer,
            type: 'standardPalette',
            align: 'vertical',
            draggable: 'false',
            items: [
              {
                id: 'undo',
                text: undefined,
                cssClass: 'djs-undo-button',
                action: {
                  type: 'click',
                  handler: [ 'commandStack', function(commandStack) {
                    commandStack.undo();
                  }]
                }
              },
              {
                id: 'redo',
                text: undefined,
                cssClass: 'djs-redo-button',
                action: {
                  type: 'click',
                  handler: [ 'commandStack', function(commandStack) {
                    commandStack.redo();
                  }]
                }

              },
              {
                id: 'addShape',
                icon: 'add.svg',
                cssClass: 'djs-rect-button',
                text: undefined,
                action: {
                  type: 'mousedown',
                  handler: [ 'canvas', 'shapes', 'selection', function(canvas, shapes, selection) {

                    var onMouseUp = function() {
                      cleanupListener();
                    }
                    //Stop on Escape
                    var onEscapeKey = function(event) {
                      if(event.keyCode === 27) {
                        cleanupListener();
                      }
                    }

                    // As chrome does not support mouseenter when left button
                    // is clicked using that complicated mousemove work around
                    var move = function(event) {

                      // If left mouse button is not pressed stop with work
                      if(event.button !== 0) {
                        return;
                      }
                      cleanupListener();
                      var newShape = shapes.convertToShape({
                        x: event.clientX - 100 / 2,
                        y: event.clientY - 80 / 2,
                        width: 100,
                        height: 80
                      });
                      canvas.addShape(newShape);
                      //TODO start drag mode of the canvas....
                      shapes.getGraphicsByShape(newShape).drag();
                      //selection.select(newShape);

                    };
                    document.addEventListener('mouseup', onMouseUp);
                    document.addEventListener('keyup', onEscapeKey);
                    canvas.addListener('mousemove', move);

                    var cleanupListener = function() {
                      canvas.removeListener('mousemove', move);
                      document.removeEventListener('mouseup', onMouseUp);
                      document.removeEventListener('keyup', onEscapeKey);
                    }
                  }]
                }
              }
            ]
          }
        ]
      });


      diagram.inject([ 'events', 'canvas', 'commandStack', 'shapes', function(events, canvas, commandStack, shapes) {

        events.on('connection.added', function(event) {
          console.log('connection added', event);
        });

        events.on('shape.added', function(event) {
          console.log('shape added', event);
        });

        var s1 = shapes.convertToShape({x: 10, y: 20, width: 100, height: 80 });
        var s2 = shapes.convertToShape({x: 80, y: 10, width: 300, height: 140});
        var s3 = shapes.convertToShape({x: 100, y: 20, width: 110, height: 110, parent: s2});
        var s4 = shapes.convertToShape({x: 300, y: 300, width: 100, height: 80 });

        // Added via command stack
        canvas.addShape(s1);
        canvas.addShape(s2);
        canvas.addShape(s3);
        canvas.addShape(s4);

        // Added via canvas directly
        canvas.addConnection({ waypoints: [ { x: 25, y: 25 }, { x: 115, y: 115} ]});
        canvas.addConnection({ waypoints: [ { x: 150, y: 150 }, { x: 200, y: 150 }, { x: 200, y: 200 }, { x: 300, y: 200} ]});
        canvas.addConnection({ waypoints: [ { x: 300, y: 300 }, { x: 100, y: 400 }, { x: 400, y: 100 }, { x: 500, y: 100 } ]});
    }]);
    }
  </script>
</head>
<body onload="createDiagram('main-svg-container', 'page-main-menu')">
  <script src='../common.js'></script>
  <script src='../diagram.js'></script>

  <div id="page-main-menu"></div>
  <div id="main-svg-container"></div>
</body>